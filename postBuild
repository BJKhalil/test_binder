#!/bin/bash
set -ex

# -------------------------------------------------------------------
# Clone and build MAIA
# -------------------------------------------------------------------
git clone --depth 1 https://github.com/onera/Maia.git
cd Maia
git submodule update --init

mkdir -p build
cd build

source /srv/conda/etc/profile.d/conda.sh
conda activate notebook

cmake ../ \
  -DCMAKE_INSTALL_PREFIX="$CONDA_PREFIX" \
  -DCMAKE_C_COMPILER=$(which mpicc) \
  -DCMAKE_CXX_COMPILER=$(which mpicxx) \
  -DCMAKE_CXX_STANDARD=17 \
  -DPython_EXECUTABLE="$CONDA_PREFIX/bin/python" \
  -DPython3_NumPy_INCLUDE_DIRS="$CONDA_PREFIX/lib/python$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')/site-packages/numpy/core/include" \
  -DCMAKE_BUILD_TYPE=Release

make -j$(nproc)
make install

# -------------------------------------------------------------------
# Create MAIA-specific Jupyter kernel
# -------------------------------------------------------------------
KERNEL_NAME="maia-kernel"
TEMP_KERNEL_DIR="/tmp/${KERNEL_NAME}"  # Temporary build directory
FINAL_KERNEL_DIR="$HOME/.local/share/jupyter/kernels/${KERNEL_NAME}"

# Create temporary kernel structure
mkdir -p "${TEMP_KERNEL_DIR}"

# Create kernel.json with MAIA-specific paths
cat > "${TEMP_KERNEL_DIR}/kernel.json" << EOF
{
 "argv": [
  "$CONDA_PREFIX/bin/python",
  "-m",
  "ipykernel_launcher",
  "-f",
  "{connection_file}"
 ],
 "display_name": "Python 3 (MAIA)",
 "language": "python",
 "metadata": {
  "debugger": true
 },
 "env": {
  "PYTHONPATH": "$CONDA_PREFIX/lib/python$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2]))')/site-packages:$CONDA_PREFIX/lib",
  "LD_LIBRARY_PATH": "$CONDA_PREFIX/lib:/usr/lib/x86_64-linux-gnu",
  "MPI4PY_RC_RECV_MPROBE": "0"
 }
}
EOF

# Add kernel logo
cat > "${TEMP_KERNEL_DIR}/logo-64x64.png" << EOF
[base64 encoded logo]
EOF

# Install from temporary directory to final location
jupyter kernelspec install --user --name="${KERNEL_NAME}" "${TEMP_KERNEL_DIR}"

# Cleanup temporary files
rm -rf "${TEMP_KERNEL_DIR}"

# Cleanup build files
cd ../..
rm -rf Maia

# -------------------------------------------------------------------
# Final verification
# -------------------------------------------------------------------
echo "MAIA installed at:"
python -c "import maia; print(maia.__file__)"

echo "Available Jupyter kernels:"
jupyter kernelspec list
