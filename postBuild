#!/bin/bash
set -ex

# Clone MAIA non-recursively
git clone --depth 1 https://github.com/onera/Maia.git
cd Maia

# Initialize critical submodules only
git submodule update --init

# Set up build directories
mkdir -p build
cd build

# Activate Conda environment
source /srv/conda/etc/profile.d/conda.sh
conda activate notebook

# Get Python site-packages path
PYTHON_SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")

# Configure CMake to install directly into Conda environment
cmake ../ \
  -DCMAKE_INSTALL_PREFIX="$PYTHON_SITE_PACKAGES" \
  -DCMAKE_C_COMPILER=$(which mpicc) \
  -DCMAKE_CXX_COMPILER=$(which mpicxx) \
  -DCMAKE_CXX_STANDARD=17 \
  -DPython_EXECUTABLE=$(which python) \
  -DPython3_NumPy_INCLUDE_DIRS=$(python -c "import numpy; print(numpy.get_include())") \
  -DCMAKE_INSTALL_LIBDIR="lib" \
  -DCMAKE_BUILD_TYPE=Release

# Build and install
make -j
make install

# Create proper Python package structure
MAIA_DIR="$PYTHON_SITE_PACKAGES/maia"
mkdir -p "$MAIA_DIR"
mv "$PYTHON_SITE_PACKAGES/"*.so "$MAIA_DIR/"
echo "__path__ = __import__('pkgutil').extend_path(__path__, __name__)" > "$MAIA_DIR/__init__.py"

# Verify installation
echo "MAIA installed at:"
python -c "import maia; print(maia.__file__)"
